!function(){"use strict";const e=(t,n=600)=>document.body?t():n<=0?console.error("[pb-chat-widget] document.body is still null"):void requestAnimationFrame(()=>e(t,n-1)),t=e=>String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"),n="pb_chat_session_id",o=()=>{let e=localStorage.getItem(n);return e||(e=(null==crypto?void 0:crypto.randomUUID)&&crypto.randomUUID()||`sid_${Math.random().toString(16).slice(2)}_${Date.now()}`,localStorage.setItem(n,e)),e},i=e=>e?"string"==typeof e?e:Array.isArray(e)?i(e[0]):e.output||e.text||e.response||e.answer||e.data&&(e.data.output||e.data.text)||"":"";e(()=>{const e=window.PB_CHAT_WIDGET_CONFIG;if(!(null==e?void 0:e.webhookUrl))return void console.error("[pb-chat-widget] Missing config. Add window.PB_CHAT_WIDGET_CONFIG = { webhookUrl: 'https://...' } before loading the script.");const n=e.title??"AI помощник",r=e.position??"bottom-right",a=e.primary??"#1677ff",d=Number(e.zIndex??2147483647),s=e.greeting??"Привет! Чем помочь?",l=document.createElement("div");l.id="pb-chat-widget-host",l.style.position="fixed",l.style.zIndex=String(d),l.style.right="bottom-right"===r?"16px":"auto",l.style.left="bottom-left"===r?"16px":"auto",l.style.bottom="16px",document.body.appendChild(l);const p=l.attachShadow({mode:"open"}),c=document.createElement("style");c.textContent=`\n    :host, * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }\n    .bubble {\n      width:56px;height:56px;border-radius:999px;background:${a};\n      box-shadow:0 12px 30px rgba(0,0,0,.18);\n      display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;\n    }\n    .bubble svg { width:26px;height:26px;fill:#fff; }\n    .win {\n      position: fixed;\n      ${"bottom-right"===r?"right:16px":"left:16px"};\n      bottom:86px;\n      width:360px; max-width: calc(100vw - 32px);\n      height:520px; max-height: calc(100vh - 120px);\n      background:#fff;border-radius:16px;\n      box-shadow:0 18px 50px rgba(0,0,0,.22);\n      overflow:hidden;display:none;\n    }\n    .win.open { display:flex; flex-direction:column; }\n    .header {\n      height:56px;display:flex;align-items:center;justify-content:space-between;\n      padding:0 14px;background:${a};color:#fff;\n    }\n    .title { font-size:14px;font-weight:700; }\n    .close {\n      width:34px;height:34px;border-radius:10px;\n      display:flex;align-items:center;justify-content:center;\n      cursor:pointer;background:rgba(255,255,255,.18);\n    }\n    .body { flex:1;padding:14px;background:#f6f7fb;overflow:auto; }\n    .row { display:flex;margin:10px 0; }\n    .row.user { justify-content:flex-end; }\n    .msg {\n      max-width:78%;padding:10px 12px;border-radius:14px;font-size:14px;line-height:1.35;\n      white-space:pre-wrap; word-wrap: break-word;\n      box-shadow:0 8px 22px rgba(0,0,0,.08);\n    }\n    .row.user .msg { background:${a};color:#fff;border-bottom-right-radius:6px; }\n    .row.bot .msg { background:#fff;color:#111;border-bottom-left-radius:6px; }\n    .footer {\n      padding:10px;background:#fff;border-top:1px solid rgba(0,0,0,.06);\n      display:flex;gap:10px;align-items:center;\n    }\n    input {\n      flex:1;height:42px;border-radius:999px;border:1px solid rgba(0,0,0,.14);\n      padding:0 14px;font-size:14px;outline:none;\n    }\n    button {\n      width:42px;height:42px;border-radius:999px;border:none;background:${a};\n      cursor:pointer;display:flex;align-items:center;justify-content:center;\n    }\n    button svg { width:20px;height:20px;fill:#fff; }\n    .typing { font-size:12px;color:rgba(0,0,0,.55);margin:6px 0 0 2px; }\n  `,p.appendChild(c);const b=document.createElement("div");b.innerHTML=`\n    <div class="bubble" aria-label="Open chat">\n      <svg viewBox="0 0 24 24" aria-hidden="true">\n        <path d="M20 2H4a2 2 0 0 0-2 2v15.5A1.5 1.5 0 0 0 3.5 21H20a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2Zm-2 10H6v-2h12v2Zm0-4H6V6h12v2Zm-6 8H6v-2h6v2Z"/>\n      </svg>\n    </div>\n\n    <div class="win" role="dialog" aria-label="Chat window">\n      <div class="header">\n        <div class="title">${t(n)}</div>\n        <div class="close" title="Закрыть">✕</div>\n      </div>\n      <div class="body"></div>\n      <div class="footer">\n        <input class="inp" placeholder="Напишите сообщение…" />\n        <button class="send" type="button" aria-label="Send">\n          <svg viewBox="0 0 24 24" aria-hidden="true">\n            <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>\n          </svg>\n        </button>\n      </div>\n    </div>\n  `,p.appendChild(b);const u=p.querySelector(".bubble"),x=p.querySelector(".win"),g=p.querySelector(".close"),h=p.querySelector(".body"),f=p.querySelector(".inp"),m=p.querySelector(".send"),v=()=>h.scrollTop=h.scrollHeight,y=(e,n)=>{const o=document.createElement("div");o.className=`row ${e}`,o.innerHTML=`<div class="msg">${t(n)}</div>`,h.appendChild(o),v()},w=e=>{let t=p.querySelector(".typing");e&&!t?(t=document.createElement("div"),t.className="typing",t.textContent="Печатает…",h.appendChild(t),v()):!e&&t&&t.remove()},k=()=>x.classList.remove("open");u.addEventListener("click",()=>x.classList.contains("open")?k():(x.classList.add("open"),void setTimeout(()=>f.focus(),0))),g.addEventListener("click",k);const S=async()=>{const t=f.value.trim();if(t){y("user",t),f.value="",w(!0);try{const n=await fetch(e.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatInput:t,sessionId:o()})}),r=await n.json().catch(()=>({})),a=i(r)||"Ок";w(!1),y("bot",a)}catch{w(!1),y("bot","Ошибка соединения")}}};m.addEventListener("click",S),f.addEventListener("keydown",e=>{"Enter"===e.key&&S()}),y("bot",s)})}();
